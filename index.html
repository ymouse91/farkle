<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Farkle ‚Äì Pistelaskuri</title>

  <!-- PWA: perusmetat -->
  <meta name="theme-color" content="#111111" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <!-- PWA: manifest -->
  <link rel="manifest" href="manifest.webmanifest" />

  <!--
    Farkle pistelaskuri (kompakti, mobiiliin sopiva)
    - Vuorossa olevan pelaajan nimi otsikon oikealla
    - Scorelistan pisteet tasattu oikealle, kiinte√§ leveys ‚Üí alkavat samasta kohdasta
  -->
  <style>
    /* --- Perustyylit ja layout --- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: #fafafa; color: #000; padding: 8px;
    }
    .container {
      max-width: 420px; margin: 0 auto; background: #fff; border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,.05); overflow: hidden; border: 1px solid #e5e7eb;
    }

    /* Header: Farkle vasemmalla, vuorossa oleva nimi oikealla */
    .header { background: #fff; padding: 10px 12px; border-bottom: 1px solid #e5e7eb; }
    .header h1 {
      font-size: 20px; font-weight: 900;
      display: flex; align-items: center; justify-content: space-between; gap: 8px;
    }
    .header h1 button { all: unset; cursor: pointer; }
    .current-name { font-size: 16px; font-weight: 700; color: #111; }

    .content { padding: 10px; }

    /* --- Pelaaja-asetukset (alkun√§kym√§) --- */
    .player-setup { text-align: center; }
    .player-setup h2 { font-size: 15px; margin-bottom: 6px; }
    .input-group { margin-bottom: 6px; }
    .input-group input {
      width: 100%; padding: 8px; border: 1.5px solid #e5e7eb; border-radius: 8px; font-size: 15px;
    }
    .btn {
      width: 100%; padding: 8px; border: none; border-radius: 8px; font-weight: 700;
      cursor: pointer; margin-bottom: 6px; font-size: 14px;
    }
    .btn-primary { background: #111; color: #fff; }
    .btn-secondary { background: #f5f5f5; border: 1px solid #e5e7eb; }
    .btn-success { background: #0a7c66; color: #fff; }
    .btn-danger { background: #b6372f; color: #fff; }

    /* --- Pistenapit --- */
    .score-input { background: #f7f7f7; padding: 8px; border-radius: 8px; margin-bottom: 8px; border: 1px solid #e5e7eb; }
    .score-buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; }
    .score-btn {
      display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px;
      padding: 6px 2px; border: 1px solid #e5e7eb; background: #fff; color: #000;
      border-radius: 6px; cursor: pointer; text-align: center; transition: transform .05s;
    }
    .score-btn .combo { font-size: 15px; font-weight: 900; }
    .score-btn .pts { font-size: 10px; color: #111; }
    .score-btn:active { transform: translateY(1px); }
    .score-btn.selected { outline: 2px solid #111; outline-offset: 1px; }

    /* --- V√§rikoodit ryhmille --- */
    .g1{ background:#e6f3ff }   /* yksitt√§iset */
    .g2{ background:#f0fff0 }   /* kaksikot */
    .g3{ background:#fff7e6 }   /* kolmoset */
    .g5{ background:#f9e6ff }   /* 4‚Äì6 samaa */
    .g6{ background:#e6fffb }   /* erikoiset */

    /* --- Toiminnot --- */
    .action-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 6px; }

    /* --- Scoreboard --- */
    .scoreboard { margin-top: 6px; }
    .player-score {
      display: flex; align-items: center; gap: 6px;
      padding: 5px 6px; background: #f7f7f7; border: 1px solid #e5e7eb; border-radius: 6px;
      margin-bottom: 4px; font-size: 13px; font-weight: 700;
    }
    .player-score.current { outline: 2px solid #111; }
    .player-score.winner { background: #0a7c66; color: #fff; border-color: #0a7c66; }

    /* Nimi vasemmalle, pisteet kiinte√§lle palstalle oikealle */
    .player-score .name {
      flex: 1 1 auto; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .player-score .score {
      /* Kiinte√§ leveys + oikea tasaus ‚Üí numerot loppuvat samaan kohtaan juuri ennen Undo-nappia */
      flex: 0 0 64px; text-align: right; margin-right: 4px;
      tab-size: 2;  /* varmistaa ettei monospacea tarvita */
    }
    .player-score .undo-btn {
      border: none; background: transparent; font-size: 16px; line-height: 1; cursor: pointer;
    }

    .winner-announcement { text-align: center; padding: 8px; background: #0a7c66; color: #fff; border-radius: 8px; margin-bottom: 8px; font-size: 14px; }

    /* --- Ohje --- */
    #scoreHelp {
      display: none; background: #fff; border: 1px solid #e5e7eb; border-radius: 8px;
      padding: 8px; margin: 6px 0; font-size: 12px; line-height: 1.3;
    }
	.player-score .undo-btn {
  border: none;
  background: transparent;
  font-size: 16px;
  line-height: 1;
  cursor: pointer;
  font-weight: bold;     /* lihavointi */
  color: #b6372f;        /* punainen v√§ri */
}
.player-score .undo-btn:hover {
  color: #8c1f1a;  /* tummempi punainen */
}

  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <!-- Farkle vasemmalla, vuorossa oleva nimi oikealla -->
      <h1>
        <button id="titleBtn">üé≤ Farkle</button>
        <span id="currentPlayerName" class="current-name"></span>
      </h1>
    </div>

    <div class="content">
      <!-- Pelaajien lis√§ys -->
      <div id="playerSetup" class="player-setup">
        <h2>Sy√∂t√§ pelaajien nimet</h2>
        <div class="input-group">
          <input id="playerNameInput" placeholder="Pelaajan nimi (tyhj√§ = valmis)" maxlength="20" />
        </div>
        <button class="btn btn-primary" onclick="addPlayer()">Lis√§√§ pelaaja</button>
        <div id="playerList" style="margin-top:6px;"></div>
        <button id="startGameBtn" class="btn btn-secondary" onclick="startGame()" style="display:none;">Aloita peli</button>
      </div>

      <!-- Ohjeet -->
      <div id="scoreHelp" class="score-help" style="display: none;">
        <div class="help-section">
          <h4>Yksitt√§iset nopat:</h4>
          <p><strong>1Ô∏è‚É£</strong> = 100p | <strong>5Ô∏è‚É£</strong> = 50p</p>
        </div>
        <div class="help-section">
          <h4>Kolmoset (3 samaa):</h4>
          <p><strong>111</strong> = 1000p | <strong>222</strong> = 200p | <strong>333</strong> = 300p</p>
          <p><strong>444</strong> =&nbsp;&ensp;400p | <strong>555</strong> = 500p | <strong>666</strong> = 600p</p>
        </div>
        <div class="help-section">
          <h4>Erikoisyhdistelm√§t:</h4>
          <p><strong>Suora (123456)</strong> = 1500p</p>
          <p><strong>3 paria</strong> = 1500p</p>
          <p><strong>4 samaa</strong> = 1000p | <strong>5 samaa</strong> = 2000p | <strong>6 samaa</strong> = 3000p</p>
        </div>
        <div class="help-section">
          <p><em>üí° Vihje: Voit valita useita pisteit√§ kerralla!</em></p>
        </div>
      </div>

      <!-- Peli -->
      <div id="gameArea" style="display:none;">
        <div class="score-input">
          <div class="score-buttons" id="scoreButtons">
            <!-- Yksitt√§iset -->
            <button class="score-btn g1" data-score="100" data-dice="1"><div class="combo">1</div><div class="pts">100p</div></button>
            <button class="score-btn g1" data-score="50" data-dice="1"><div class="combo">5</div><div class="pts">50p</div></button>

            <!-- Kaksikot -->
            <br>
            <button class="score-btn g2" data-score="200" data-dice="2"><div class="combo">11</div><div class="pts">200p</div></button>
            <button class="score-btn g2" data-score="100" data-dice="2"><div class="combo">55</div><div class="pts">100p</div></button>

            <!-- Kolmoset -->
            <br>
            <button class="score-btn g3" data-score="1000" data-dice="3"><div class="combo">111</div><div class="pts">1000p</div></button>
            <button class="score-btn g3" data-score="200" data-dice="3"><div class="combo">222</div><div class="pts">200p</div></button>
            <button class="score-btn g3" data-score="300" data-dice="3"><div class="combo">333</div><div class="pts">300p</div></button>
            <button class="score-btn g3" data-score="400" data-dice="3"><div class="combo">444</div><div class="pts">400p</div></button>
            <button class="score-btn g3" data-score="500" data-dice="3"><div class="combo">555</div><div class="pts">500p</div></button>
            <button class="score-btn g3" data-score="600" data-dice="3"><div class="combo">666</div><div class="pts">600p</div></button>

            <!-- Isommat sarjat -->
            <button class="score-btn g5" data-score="1000" data-dice="4"><div class="combo">4 samaa</div><div class="pts">1000p</div></button>
            <button class="score-btn g5" data-score="2000" data-dice="5"><div class="combo">5 samaa</div><div class="pts">2000p</div></button>
            <button class="score-btn g5" data-score="3000" data-dice="6"><div class="combo">6 samaa</div><div class="pts">3000p</div></button>
            <!-- Erikoiset -->
            <button class="score-btn g6" data-score="1500" data-dice="6"><div class="combo">Suora</div><div class="pts">1500p</div></button>
            <button class="score-btn g6" data-score="1500" data-dice="6"><div class="combo">3 paria</div><div class="pts">1500p</div></button>
          </div>

          <!-- Nopparajan varoitus -->
          <div id="diceWarning" style="display:none;color:#b6372f;font-size:12px;margin:6px 2px;">
            ‚ö†Ô∏è Yli 6 noppaa valittuna. Poista jokin valinta.
          </div>

          <!-- Toimintonapit -->
          <div class="action-buttons">
            <button class="btn btn-success" onclick="addToScore()">Lis√§√§</button>
            <button class="btn btn-danger" onclick="bustTurn()">Bust</button>
          </div>
        </div>

        <!-- Pistetaulukko -->
        <div class="scoreboard">
          <div id="scoreList"></div>
          <div id="turnHint" style="font-size:12px;color:#555;text-align:center;margin-top:4px;display:none;">
            Valitse pelaaja aloittaaksesi vuoron
          </div>
        </div>

        <!-- Voittajan ilmoitus -->
        <div id="winnerArea" style="display:none;">
          <div class="winner-announcement">
            <h2>üèÜ Voittaja!</h2>
            <p id="winnerName"></p>
          </div>
        </div>

        <!-- Alapalkin toiminnot -->
        <div class="action-buttons" style="margin-top:6px;">
          <button class="btn btn-secondary" onclick="newRound()">Uusi kierros</button>
          <button class="btn btn-primary" onclick="newGame()">Uusi peli</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- Sovelluksen tila ---
    // players: { name, score, qualified, history[], turnAcc }
    let players = [];
    let currentPlayerIndex = -1;          // moninpeliss√§ -1 = ei valittua pelaajaa alussa
    let currentTurnScore = 0;             // valittujen nappien summa (t√§h√§n heittoon)
    let selectedScores = [];              // valittujen nappien pisteet listana
    let gameWinner = null;                // {name, ...} kun score >= 10000

    // --- Pelaajien lis√§√§minen ---
    window.addPlayer = function () {
      const input = document.getElementById('playerNameInput');
      const name = (input.value || '').trim();

      // Tyhj√§ sy√∂te = siirtyminen aloitukseen (kun v√§hint√§√§n 1 pelaaja)
      if (name === '') {
        if (players.length < 1) { alert('Tarvitset v√§hint√§√§n 1 pelaajan!'); return; }
        document.getElementById('startGameBtn').style.display = 'block';
        input.style.display = 'none';
        document.querySelector('.btn-primary').style.display = 'none';
        return;
      }

      if (players.some(p => p.name === name)) { alert('Pelaaja on jo lis√§tty!'); return; }

      // Uusi pelaaja
      players.push({ name, score: 0, qualified: false, history: [], turnAcc: 0 });
      updatePlayerList();
      input.value = '';
      input.focus();
    };

    // P√§ivit√§ pelaajalista l√§ht√∂n√§kym√§ss√§
    function updatePlayerList() {
      const list = document.getElementById('playerList');
      list.innerHTML = players
        .map(p => `<p style="background:#f7f7f7;border:1px solid #e5e7eb;padding:4px;border-radius:6px;margin-bottom:3px;font-size:13px;">${p.name}</p>`)
        .join('');
    }

    // --- Pelin aloitus ---
    window.startGame = function () {
      if (players.length < 1) { alert('Tarvitset v√§hint√§√§n 1 pelaajan!'); return; }

      // Yksinpeli: kvalis√§√§nt√∂ pois ja valitaan pelaaja automaattisesti
      if (players.length === 1) { players[0].qualified = true; }

      // Moninpeli: valitaan ensimm√§inen pelaaja aloituksessa,
      // jotta pisteiden lis√§√§minen toimii heti.
      currentPlayerIndex = 0;
      players.forEach(p => p.turnAcc = 0);

      document.getElementById('playerSetup').style.display = 'none';
      document.getElementById('gameArea').style.display = 'block';

      updateScoreboard();
      setupScoreButtons();
    };

    // --- Pistenappien klikkauksen k√§sittely ---
    function setupScoreButtons() {
      document.querySelectorAll('.score-btn').forEach(btn => {
        btn.addEventListener('click', function () {
          const score = parseInt(this.dataset.score, 10);
          toggleScoreSelection(this, score);
        });
      });
    }

    // Toggle-valinta + nopparaja 6
    function toggleScoreSelection(button, score) {
      if (button.classList.contains('selected')) {
        button.classList.remove('selected');
        const i = selectedScores.indexOf(score);
        if (i > -1) selectedScores.splice(i, 1);
      } else {
        button.classList.add('selected');
        selectedScores.push(score);
      }

      // Lasketaan valittujen noppien m√§√§r√§ data-dice -attribuutista
      const totalDice = Array.from(document.querySelectorAll('.score-btn.selected'))
        .reduce((sum, el) => sum + (parseInt(el.dataset.dice, 10) || 0), 0);
      const warn = document.getElementById('diceWarning');

      // Jos yli 6 noppaa -> perutaan viimeisin valinta
      if (totalDice > 6) {
        button.classList.remove('selected');
        const i = selectedScores.indexOf(score);
        if (i > -1) selectedScores.splice(i, 1);
        warn.style.display = 'block';
        return;
      } else {
        warn.style.display = 'none';
      }

      // P√§ivit√§ vuoron valittujen pisteiden summa
      currentTurnScore = selectedScores.reduce((s, v) => s + v, 0);
    }

    // --- Pisteiden lis√§√§minen aktiiviselle pelaajalle ---
    window.addToScore = function () {
      if (!currentTurnScore) { alert('Valitse ensin pisteet!'); return; }
      if (players.length > 1 && currentPlayerIndex < 0) { alert('Valitse pelaaja taulukosta.'); return; }

      const p = players[currentPlayerIndex >= 0 ? currentPlayerIndex : 0];

      // Yksinpeli: ei kvalis√§√§nt√∂√§
      if (players.length === 1) {
        p.score += currentTurnScore;
        p.history.push(currentTurnScore);
        p.turnAcc += currentTurnScore;
        if (p.score >= 10000) { gameWinner = p; showWinner(); return; }
      } else {
        // Moninpeli: 1000p sis√§√§n (aloituskynnys 500 kuten aiemmin)
        if (!p.qualified && p.score + currentTurnScore >= 500) p.qualified = true;
        if (p.qualified || p.score + currentTurnScore >= 500) {
          p.score += currentTurnScore;
          p.history.push(currentTurnScore);
          p.turnAcc += currentTurnScore;
          if (p.score >= 10000) { gameWinner = p; showWinner(); return; }
        }
      }

      // Tyhjenn√§ kuluvan heiton valinnat
      currentTurnScore = 0;
      selectedScores = [];
      document.querySelectorAll('.score-btn').forEach(b => b.classList.remove('selected'));
      updateScoreboard();
    };

    // --- Bust: menetet√§√§n kuluvan vuoron kertym√§ (turnAcc) ---
    window.bustTurn = function () {
      if (currentPlayerIndex >= 0) {
        const p = players[currentPlayerIndex];
        const lose = p.turnAcc || 0;
        if (lose > 0) {
          p.score -= lose;           // v√§henn√§ vuorokertym√§ pisteist√§
          p.history.push(-lose);     // kirjaa negatiivinen merkint√§ historiaan
          p.turnAcc = 0;             // nollaa vuorokertym√§
          // p√§ivitys kvaliin (yksinpeliss√§ aina true)
          p.qualified = (players.length === 1) || (p.score >= 1000);
        }
      }
      // Nollaa t√§m√§n heiton tilat
      currentTurnScore = 0;
      selectedScores = [];
      document.querySelectorAll('.score-btn').forEach(b => b.classList.remove('selected'));
      updateScoreboard();
    };

    // --- Uusi kierros (nollaa pisteet, s√§ilytt√§√§ pelaajat) ---
    window.newRound = function () {
      players.forEach(p => { p.score = 0; p.history = []; p.turnAcc = 0; p.qualified = (players.length === 1); });
      currentPlayerIndex = (players.length >= 1 ? 0 : -1);
      currentTurnScore = 0; selectedScores = []; gameWinner = null;
      document.getElementById('winnerArea').style.display = 'none';
      document.querySelector('.score-input').style.display = 'block';
      document.querySelectorAll('.score-btn').forEach(b => b.classList.remove('selected'));
      updateScoreboard();
    };

    // --- Uusi peli (tyhjent√§√§ kaiken) ---
    window.newGame = function () {
      players = []; currentPlayerIndex = -1; currentTurnScore = 0; selectedScores = []; gameWinner = null;
      document.getElementById('gameArea').style.display = 'none';
      document.getElementById('playerSetup').style.display = 'block';
      document.getElementById('playerNameInput').style.display = 'block';
      document.querySelector('.btn-primary').style.display = 'block';
      document.getElementById('startGameBtn').style.display = 'none';
      document.getElementById('winnerArea').style.display = 'none';
      document.querySelector('.score-input').style.display = 'block';
      document.getElementById('playerNameInput').value = '';
      document.getElementById('playerList').innerHTML = '';
      document.querySelectorAll('.score-btn').forEach(b => b.classList.remove('selected'));
      currentTurnScore = 0; selectedScores = [];
      document.getElementById('playerNameInput').focus();
      updateScoreboard(); // tyhjenn√§ my√∂s otsikon nimi
    };

    // --- Scoreboardin p√§ivitys ---
    function updateScoreboard() {
      const list = document.getElementById('scoreList');
      const solo = (players.length === 1);
      const hint = document.getElementById('turnHint');

      // N√§yt√§ vihje, jos moninpeliss√§ kukaan ei ole valittuna
      if (hint) hint.style.display = (!solo && currentPlayerIndex < 0) ? 'block' : 'none';

      list.innerHTML = players.map((p, i) => {
        let cls = 'player-score';
        if (!gameWinner && i === currentPlayerIndex) cls += ' current';
        if (gameWinner && p === gameWinner) cls += ' winner';
        const qualified = solo ? '' : ((p.qualified || p.score >= 1000) ? ' ‚úì' : ' ‚≠ï');
        return `
          <div class="${cls}" onclick="selectPlayer(${i})">
            <span class="name">${p.name}${qualified}</span>
            <span class="score">${p.score}</span>
            <button
              class="undo-btn"
              onclick="undoLast(${i});event.stopPropagation();"
              title="Peru viimeisin lis√§ys"
            >‚ìß</button>
          </div>`;
      }).join('');

      // P√§ivit√§ otsikon oikea laita: vuorossa oleva pelaaja
      const nameBox = document.getElementById('currentPlayerName');
      if (nameBox) {
        if (currentPlayerIndex >= 0 && players[currentPlayerIndex]) {
          nameBox.textContent = players[currentPlayerIndex].name;
        } else {
          nameBox.textContent = '';
        }
      }
    }

    // --- Voittajan n√§ytt√∂ ---
    function showWinner() {
      document.getElementById('winnerArea').style.display = 'block';
      document.getElementById('winnerName').textContent = `${gameWinner.name} voitti ${gameWinner.score} pisteell√§!`;
      document.querySelector('.score-input').style.display = 'none';
      updateScoreboard();
    }

    // --- Pelaajan valinta (moninpeli) ---
    window.selectPlayer = function (i) {
      currentPlayerIndex = (players.length === 1 ? 0 : i);
      if (currentPlayerIndex >= 0) {
        // Tuore vuoro valitulle pelaajalle
        players[currentPlayerIndex].turnAcc = 0;
      }
      updateScoreboard();
    };

    // --- Peru viimeisin lis√§ys pelaajalta ---
    window.undoLast = function (i) {
      const p = players[i];
      if (!p || !p.history || !p.history.length) return;
      const last = p.history.pop();               // poista viimeisin merkint√§ (voi olla my√∂s negatiivinen)
      p.score = p.history.reduce((a, b) => a + b, 0);

      // Jos perutaan aktiivisen pelaajan t√§m√§n vuoron lis√§ys, korjaa turnAcc
      if (i === currentPlayerIndex && last > 0) {
        p.turnAcc = Math.max(0, (p.turnAcc || 0) - last);
      }
      // P√§ivit√§ kvali
      p.qualified = (players.length === 1) || (p.score >= 1000);

      updateScoreboard();
    };

    // --- Boot: UI-kytkenn√§t ja pienet testit ---
    document.addEventListener('DOMContentLoaded', () => {
      // Otsikon napista ohje auki/kiinni
      document.getElementById('titleBtn').addEventListener('click', () => {
        const h = document.getElementById('scoreHelp');
        h.style.display = (h.style.display === 'none' || !h.style.display) ? 'block' : 'none';
      });

      // Enter lis√§√§ pelaajan sy√∂tt√∂kent√§st√§
      const inp = document.getElementById('playerNameInput');
      inp.addEventListener('keypress', e => { if (e.key === 'Enter') addPlayer(); });
      inp.focus();

      // PWA: rekister√∂i service worker
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js');
        });
      }

      // Smoke-testit (kehitt√§j√§lle konsoliin)
      try {
        console.assert(typeof window.addPlayer === 'function', 'addPlayer should be defined');
        console.assert(document.querySelectorAll('.score-btn').length === 15, 'Should render 15 score buttons');
      } catch (e) {
        console.warn('Smoke test failed', e);
      }
    });
  </script>
</body>
</html>
